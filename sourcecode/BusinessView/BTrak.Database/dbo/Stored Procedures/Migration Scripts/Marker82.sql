CREATE PROCEDURE [dbo].[Marker82]
(
    @CompanyId UNIQUEIDENTIFIER,
    @UserId UNIQUEIDENTIFIER,
    @RoleId UNIQUEIDENTIFIER
)
AS 
BEGIN 

        UPDATE [dbo].[CustomWidgets] SET [WidgetQuery] = 'SELECT LeftInner.testsuitename AS [Testsuite name], Cast(Cast(Isnull(LeftInner.totalestimate/(60*60.0), 0) AS INT)AS VARCHAR( 100)) + ''h '' + Iif(Cast(Isnull(LeftInner.totalestimate, 0)/(60)% Cast(60 AS DECIMAL(10 , 3)) AS INT) = 0, '''', Cast(Cast(Isnull(LeftInner.totalestimate, 0)/(60)% Cast( 60 AS DECIMAL(10, 3)) AS INT) AS VARCHAR(100))+''m'') [Estimate in hours], LeftInner.casescount AS [Cases count], LeftInner.runscount AS [Runs count], Cast(LeftInner.createddatetime AS DATETIME) AS [Created on], LeftInner.sectionscount AS [sections count], Isnull(RightInner.p0bugscount, 0) AS [P0 bugs], Isnull(RightInner.p1bugscount, 0) AS [P1 bugs], Isnull(RightInner.p2bugscount, 0) AS [P2 bugs], Isnull(RightInner.p3bugscount, 0) AS [P3 bugs], Isnull(RightInner.totalbugscount, 0) AS [Total bugs count], LeftInner.testsuiteid Id FROM (SELECT TS.id TestSuiteId, testsuitename, (SELECT Count(1) FROM testsuitesection TSS INNER JOIN testcase TC ON TC.sectionid = TSS.id AND TSS.inactivedatetime IS NULL AND TC.inactivedatetime IS NULL WHERE TSS.testsuiteid = TS.id) CasesCount, (SELECT Count(1) FROM testsuitesection TSS WHERE TSS.testsuiteid = TS.id AND TSS.inactivedatetime IS NULL)SectionsCount, (SELECT Count(1) FROM testrun TR WHERE TR.testsuiteid = TS.id AND TR.inactivedatetime IS NULL) RunsCount, TS.createddatetime, (SELECT Sum(Isnull(TC.estimate, 0)) Estimate FROM testcase TC INNER JOIN testsuitesection TSS ON TSS.id = TC.sectionid AND TSS.inactivedatetime IS NULL AND TC.inactivedatetime IS NULL WHERE TC.inactivedatetime IS NULL AND TC.testsuiteid = TS.id) AS TotalEstimate FROM testsuite TS INNER JOIN project P ON P.id = TS.projectid AND P.inactivedatetime IS NULL AND ( ''@ProjectId'' = '''' OR P.id = ''@ProjectId'' ) AND P.companyid = ''@CompanyId'' WHERE TS.inactivedatetime IS NULL)LeftInner LEFT JOIN (SELECT Count(CASE WHEN BP.iscritical = 1 THEN 1 END) P0BugsCount, Count(CASE WHEN BP.ishigh = 1 THEN 1 END) P1BugsCount, Count(CASE WHEN BP.ismedium = 1 THEN 1 END) P2BugsCount, Count(CASE WHEN BP.islow = 1 THEN 1 END) P3BugsCount, Count(1) TotalBugsCount, TSS.testsuiteid FROM userstory US INNER JOIN userstorytype UST ON UST.id = US.userstorytypeid AND UST.inactivedatetime IS NULL AND UST.isbug = 1 INNER JOIN testcase TC ON TC.id = US.testcaseid AND TC.inactivedatetime IS NULL INNER JOIN testsuitesection TSS ON TSS.id = TC.sectionid AND TSS.inactivedatetime IS NULL LEFT JOIN [bugpriority]BP ON BP.id = US.bugpriorityid AND BP.inactivedatetime IS NULL LEFT JOIN goal G ON G.id = US.goalid AND G.inactivedatetime IS NULL AND G.parkeddatetime IS NULL LEFT JOIN goalstatus GS ON GS.id = g.goalstatusid AND GS.isactive = 1 LEFT JOIN sprints S ON S.id = US.sprintid AND S.inactivedatetime IS NULL AND S.sprintstartdate IS NOT NULL AND ( S.isreplan IS NULL OR S.isreplan = 0 ) WHERE ( ( US.goalid IS NOT NULL AND US.InActiveDateTime IS NULL AND G.id IS NOT NULL AND GS.id IS NOT NULL ) OR ( US.sprintid IS NOT NULL AND S.id IS NULL ) ) GROUP BY TSS.testsuiteid)RightInner ON LeftInner.testsuiteid = RightInner.testsuiteid' WHERE [CustomWidgetName] = 'All test suites' AND companyId=@CompanyId

END
GO